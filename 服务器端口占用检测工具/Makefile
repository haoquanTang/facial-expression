# æœåŠ¡å™¨ç«¯å£å ç”¨æ£€æµ‹å·¥å…· Makefile

.PHONY: help install test clean run-gui run-cli build package dev-setup lint format check-deps

# é»˜è®¤ç›®æ ‡
help:
	@echo "æœåŠ¡å™¨ç«¯å£å ç”¨æ£€æµ‹å·¥å…· - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "  install      - å®‰è£…é¡¹ç›®ä¾èµ–"
	@echo "  test         - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test-verbose - è¿è¡Œè¯¦ç»†æµ‹è¯•"
	@echo "  clean        - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo "  run-gui      - å¯åŠ¨GUIæ¨¡å¼"
	@echo "  run-cli      - å¯åŠ¨å‘½ä»¤è¡Œæ¨¡å¼(æ‰«æå¸¸ç”¨ç«¯å£)"
	@echo "  build        - æ„å»ºé¡¹ç›®"
	@echo "  package      - æ‰“åŒ…é¡¹ç›®"
	@echo "  dev-setup    - å¼€å‘ç¯å¢ƒè®¾ç½®"
	@echo "  lint         - ä»£ç æ£€æŸ¥"
	@echo "  format       - ä»£ç æ ¼å¼åŒ–"
	@echo "  check-deps   - æ£€æŸ¥ä¾èµ–"
	@echo "  demo         - è¿è¡Œæ¼”ç¤º"
	@echo ""

# å®‰è£…ä¾èµ–
install:
	@echo "å®‰è£…é¡¹ç›®ä¾èµ–..."
	pip install -r requirements.txt
	@echo "ä¾èµ–å®‰è£…å®Œæˆ!"

# è¿è¡Œæµ‹è¯•
test:
	@echo "è¿è¡Œæµ‹è¯•å¥—ä»¶..."
	python tests/run_tests.py

test-verbose:
	@echo "è¿è¡Œè¯¦ç»†æµ‹è¯•..."
	python tests/run_tests.py --no-deps-check
	python -m unittest discover -s tests -p "test_*.py" -v

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
clean:
	@echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf build/ dist/ .pytest_cache/
	@echo "æ¸…ç†å®Œæˆ!"

# å¯åŠ¨GUIæ¨¡å¼
run-gui:
	@echo "å¯åŠ¨GUIæ¨¡å¼..."
	python src/main.py --gui

# å¯åŠ¨å‘½ä»¤è¡Œæ¨¡å¼
run-cli:
	@echo "å¯åŠ¨å‘½ä»¤è¡Œæ¨¡å¼ - æ‰«æå¸¸ç”¨ç«¯å£..."
	python src/main.py --ports "22,80,443,3306,5432,6379,8080,9000" --output table

# æ¼”ç¤ºæ‰«æ
demo:
	@echo "æ¼”ç¤ºç«¯å£æ‰«æåŠŸèƒ½..."
	@echo "1. æ‰«ææœ¬åœ°å¸¸ç”¨ç«¯å£:"
	python src/main.py --ports "22,80,443,8080" --output table --timeout 2
	@echo ""
	@echo "2. æ‰«æç«¯å£èŒƒå›´:"
	python src/main.py --ports "8000-8005" --output json --timeout 1
	@echo ""
	@echo "3. æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯:"
	python src/main.py --help

# æ„å»ºé¡¹ç›®
build:
	@echo "æ„å»ºé¡¹ç›®..."
	python setup.py build
	@echo "æ„å»ºå®Œæˆ!"

# æ‰“åŒ…é¡¹ç›®
package:
	@echo "æ‰“åŒ…é¡¹ç›®..."
	python setup.py sdist bdist_wheel
	@echo "æ‰“åŒ…å®Œæˆ! æŸ¥çœ‹ dist/ ç›®å½•"

# å¼€å‘ç¯å¢ƒè®¾ç½®
dev-setup: install
	@echo "è®¾ç½®å¼€å‘ç¯å¢ƒ..."
	@echo "åˆ›å»ºå¿…è¦çš„ç›®å½•..."
	mkdir -p logs
	mkdir -p output
	@echo "å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ!"

# ä»£ç æ£€æŸ¥ (å¦‚æœå®‰è£…äº†flake8)
lint:
	@echo "è¿è¡Œä»£ç æ£€æŸ¥..."
	@if command -v flake8 >/dev/null 2>&1; then \
		flake8 src/ tests/ --max-line-length=100 --ignore=E501,W503; \
	else \
		echo "flake8 æœªå®‰è£…ï¼Œè·³è¿‡ä»£ç æ£€æŸ¥"; \
		echo "å®‰è£…: pip install flake8"; \
	fi

# ä»£ç æ ¼å¼åŒ– (å¦‚æœå®‰è£…äº†black)
format:
	@echo "æ ¼å¼åŒ–ä»£ç ..."
	@if command -v black >/dev/null 2>&1; then \
		black src/ tests/ --line-length=100; \
	else \
		echo "black æœªå®‰è£…ï¼Œè·³è¿‡ä»£ç æ ¼å¼åŒ–"; \
		echo "å®‰è£…: pip install black"; \
	fi

# æ£€æŸ¥ä¾èµ–
check-deps:
	@echo "æ£€æŸ¥é¡¹ç›®ä¾èµ–..."
	python tests/run_tests.py --check-deps

# å®‰è£…å¼€å‘ä¾èµ–
install-dev:
	@echo "å®‰è£…å¼€å‘ä¾èµ–..."
	pip install flake8 black pytest pytest-cov
	@echo "å¼€å‘ä¾èµ–å®‰è£…å®Œæˆ!"

# è¿è¡Œè¦†ç›–ç‡æµ‹è¯•
test-coverage:
	@echo "è¿è¡Œæµ‹è¯•è¦†ç›–ç‡åˆ†æ..."
	@if command -v pytest >/dev/null 2>&1; then \
		pytest tests/ --cov=src --cov-report=html --cov-report=term; \
		echo "è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆåœ¨ htmlcov/ ç›®å½•"; \
	else \
		echo "pytest æœªå®‰è£…ï¼Œä½¿ç”¨åŸºæœ¬æµ‹è¯•"; \
		make test; \
	fi

# å¿«é€Ÿå¼€å§‹
quick-start: dev-setup test
	@echo ""
	@echo "ğŸ‰ é¡¹ç›®è®¾ç½®å®Œæˆ!"
	@echo ""
	@echo "å¿«é€Ÿä½¿ç”¨:"
	@echo "  make run-gui    # å¯åŠ¨å›¾å½¢ç•Œé¢"
	@echo "  make run-cli    # å‘½ä»¤è¡Œæ‰«æ"
	@echo "  make demo       # æŸ¥çœ‹æ¼”ç¤º"
	@echo ""

# é¡¹ç›®ä¿¡æ¯
info:
	@echo "é¡¹ç›®ä¿¡æ¯:"
	@echo "  åç§°: æœåŠ¡å™¨ç«¯å£å ç”¨æ£€æµ‹å·¥å…·"
	@echo "  ç‰ˆæœ¬: 1.0.0"
	@echo "  Python: $(shell python --version)"
	@echo "  ç›®å½•: $(shell pwd)"
	@echo "  æ–‡ä»¶æ•°: $(shell find src/ -name '*.py' | wc -l) Pythonæ–‡ä»¶"
	@echo "  ä»£ç è¡Œæ•°: $(shell find src/ -name '*.py' -exec wc -l {} + | tail